#!/bin/sh

# exit if a command fails
set -e

# Make sure webroot exists
echo "### Make sure webroot exists..."
mkdir -p ${CONFIG_HTTPD_DOCUMENT_ROOT}

# Create server conf
echo "### Create server conf..."
sed -i 's/User daemon/User ${CONFIG_USERS_MAIN_NAME}/g' "$SETUP_HTTPD_CONF_MAIN"
sed -i 's/Group daemon/Group ${CONFIG_GROUPS_MAIN_NAME}/g' $SETUP_HTTPD_CONF_MAIN
cat "$CONFIG_PATHS_TEMPLATES_HTTPD_SERVER" | envsubst > "$CONFIG_PATHS_CONF_HTTPD_SERVER"

# Create Production configurations
echo "### Create Production configurations..."
if [ "$BUILD_ENV" = "$GENERAL_KEYS_PRD" ]; then
    cat "$CONFIG_PATHS_TEMPLATES_HTTPD_SSL" | envsubst > "$CONFIG_PATHS_CONF_HTTPD_SSL";
fi
# Create fastcgi conf
echo "### Create fastcgi conf..."
if [ "$SETUP_PHP_FPM" = "$GENERAL_KEYS_TRUE" ]; then
    cat "$CONFIG_PATHS_TEMPLATES_HTTPD_FASTCGI" | envsubst > "$CONFIG_PATHS_CONF_HTTPD_FASTCGI";
fi
# Set vhost template
echo "### Set vhost template..."
if [ "$BUILD_ENV" = "$GENERAL_KEYS_DEV" ]; then
    VHOST_TEMPLATE=$CONFIG_PATHS_TEMPLATES_HTTPD_VHOST_DEV;
else 
        VHOST_TEMPLATE=$CONFIG_PATHS_TEMPLATES_HTTPD_VHOST_PRD;
fi
# Create vhost conf
echo "### Create vhost conf..."
cat "$VHOST_TEMPLATE" | envsubst > "$CONFIG_PATHS_CONF_HTTPD_VHOST"



exit 0