#!/bin/sh
#
# Run all configuration scripts
#
set -e

touch /tmp/container_status
if [ ! -f "/tmp/container_status" ];
then
    echo "Error: Can't create container_status file /tmp/container_status";
    exit 1;
fi

echo "### Starting container configuration"
echo "running_config" > /tmp/container_status

#
# Groups
#

# Add main group
if [ ! -z "$CONFIG_GROUPS_MAIN_NAME" ]; then
    if ! getent group "$CONFIG_GROUPS_MAIN_NAME"; then
        addgroup -S "$CONFIG_GROUPS_MAIN_NAME";
    fi
    
    # Check
    if [ -z "$(getent group "$CONFIG_GROUPS_MAIN_NAME")" ]; then
        echo "Missing group $CONFIG_GROUPS_MAIN_NAME"
        exit 1;
    fi
fi



# Add additional group
if [ ! -z "$CONFIG_GROUPS_ADDITIONAL_NAME" ] ; then
    if ! getent group "$CONFIG_GROUPS_ADDITIONAL_NAME"; then
        addgroup -S "$CONFIG_GROUPS_ADDITIONAL_NAME";
    fi
    # Check
    if [ -z "$(getent group "$CONFIG_GROUPS_ADDITIONAL_NAME")" ]; then
        echo "Missing group $CONFIG_GROUPS_ADDITIONAL_NAME"
        exit 1;
    fi
fi


# Main user
if [ ! -z "$CONFIG_USERS_MAIN_NAME" ]; then
    # Add user if not exists 
    if ! id -u "$CONFIG_USERS_MAIN_NAME"; then
        adduser "$CONFIG_USERS_MAIN_NAME";
    fi
    
    # Add user to each group is not assigned
    for group in $CONFIG_USERS_MAIN_GROUPS;
    do
        # Check if user is already assiged
        if id -nG "$CONFIG_USERS_MAIN_NAME" | grep -qw "$group"; then
            true; 
        else
            adduser -S "$CONFIG_USERS_MAIN_NAME" "$group";
        fi
    done;

    # Check
    id -u "$CONFIG_USERS_MAIN_NAME"
fi


# Add additional user
if [ ! -z "$CONFIG_USERS_ADDITIONAL_NAME" ]; then
    # Add user if not exists 
    if ! id -u "$CONFIG_USERS_ADDITIONAL_NAME"; then
        adduser "$CONFIG_USERS_ADDITIONAL_NAME";
    fi
    
    # Add user to each group is not assigned
    for group in $CONFIG_USERS_ADDITIONAL_GROUPS;
    do
        # Check if user is already assiged
        if id -nG "$CONFIG_USERS_ADDITIONAL_NAME" | grep -qw "$group"; then
            true; 
        else
            adduser -S "$CONFIG_USERS_ADDITIONAL_NAME" "$group";
        fi
    done
    
    # Check
    id -u "$CONFIG_USERS_ADDITIONAL_NAME"
fi

#
# Configurations
#
for config_script in /usr/local/bin/config/*; 
do
    $config_script 1>/dev/stdout 2>/dev/stderr; 
done;

# End configuration
echo "ready" > /tmp/container_status
echo "### Finished container configuration"

exit 0